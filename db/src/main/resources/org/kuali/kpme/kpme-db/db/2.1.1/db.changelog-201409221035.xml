<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!--

    Copyright 2004-2014 The Kuali Foundation

    Licensed under the Educational Community License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

    http://www.opensource.org/licenses/ecl2.php

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">


	
    <changeSet id="1" author="neerajsk" context="kpme-server-bootstrap">
        <comment>Create the KPME Employee Setup Context in the KPME-HR namespace and set the (pre-defined) rule and action types as valid for this context </comment>

        <insert tableName="KRMS_CNTXT_T">
            <column name="CNTXT_ID" value="KPME-EMP-SETUP-CONTEXT" />
            <column name="NMSPC_CD" value="KPME-HR"/>
            <column name="NM" value="KPME Employee Setup Context"/>
            <column name="TYP_ID" value="KPME0001" />
            <column name="ACTV" value="Y" />
            <column name="VER_NBR" value="0" />
            <column name="DESC_TXT" value="KPME context for Employee Setup" />
        </insert>
        
         <insert tableName="KRMS_CNTXT_VLD_RULE_TYP_T">
            <column name="CNTXT_VLD_RULE_ID" value="KPME0006"/>
            <column name="CNTXT_ID" value="KPME-EMP-SETUP-CONTEXT"/>
            <column name="RULE_TYP_ID" valueComputed="(select TYP_ID from KRMS_TYP_T where NM='Validation Rule' and NMSPC_CD='KR-RULE')" />
        </insert>
        
        <insert tableName="KRMS_CNTXT_VLD_ACTN_TYP_T">
            <column name="CNTXT_VLD_ACTN_ID" value="KPME0019"/>
            <column name="CNTXT_ID" value="KPME-EMP-SETUP-CONTEXT"/>
            <column name="ACTN_TYP_ID" valueComputed="(select TYP_ID from KRMS_TYP_T where NM='Validation Action' and NMSPC_CD='KR-RULE')" />
        </insert>
        
        <insert tableName="KRMS_CNTXT_VLD_ACTN_TYP_T">
            <column name="CNTXT_VLD_ACTN_ID" value="KPME0020"/>
            <column name="CNTXT_ID" value="KPME-EMP-SETUP-CONTEXT"/>
            <column name="ACTN_TYP_ID" valueComputed="(select TYP_ID from KRMS_TYP_T where NM='Notify PeopleFlow' and NMSPC_CD='KR-RULE')" />
        </insert>
        
        <insert tableName="KRMS_CNTXT_VLD_ACTN_TYP_T">
            <column name="CNTXT_VLD_ACTN_ID" value="KPME0021"/>
            <column name="CNTXT_ID" value="KPME-EMP-SETUP-CONTEXT"/>
            <column name="ACTN_TYP_ID" valueComputed="(select TYP_ID from KRMS_TYP_T where NM='Route to PeopleFlow' and NMSPC_CD='KR-RULE')" />
        </insert>
    </changeSet>
    
    
    <changeSet id="2" author="neerajsk" context="kpme-server-bootstrap">
        <comment>Create the term specification for the employee setup process </comment>

        <insert tableName="KRMS_TERM_SPEC_T">
            <column name="TERM_SPEC_ID" value="KPME0014" />
            <column name="NM" value="employeeSetupProcess"/>
            <column name="TYP" value="java.lang.String"/>
            <column name="ACTV" value="Y" />
            <column name="VER_NBR" value="1" />
            <column name="DESC_TXT" value="The process used when setting up the employee details" />
            <column name="NMSPC_CD" value="KPME-HR" />
        </insert>
    </changeSet>
    
    <changeSet id="3" author="neerajsk" context="kpme-server-bootstrap">
        <comment>Create the actual term for the setup process, based on the above specification, so it can be used as a parameter in propositions for agenda rules</comment>
        
        <insert tableName="KRMS_TERM_T">
            <column name="TERM_ID" value="KPME0006" />
            <column name="TERM_SPEC_ID" value="KPME0014"/>
            <column name="VER_NBR" value="1"/>
            <column name="DESC_TXT" value="The process used when setting up the employee details" />
        </insert>
    </changeSet>
    
    <changeSet id="4" author="neerajsk" context="kpme-server-bootstrap">
        <comment>Set the above process term specification as valid for the employee setup context, so it can be used in agendas for that context</comment>

        <insert tableName="KRMS_CNTXT_VLD_TERM_SPEC_T">
            <column name="CNTXT_TERM_SPEC_PREREQ_ID" value="KPME0024" />
            <column name="CNTXT_ID" value="KPME-EMP-SETUP-CONTEXT"/>
            <column name="TERM_SPEC_ID" value="KPME0014"/>
            <column name="PREREQ" value="N" />
        </insert>
    </changeSet>
        
        
    <changeSet id="5" author="neerajsk" context="kpme-server-bootstrap">
        <comment>Create a proposition that checks if the value of the setup process is 'New job/Payrate', and use that proposition in a new rule. </comment>
        
        <insert tableName="KRMS_PROP_T">
            <column name="PROP_ID" value="KPME0007"/>
            <column name="DESC_TXT" value="Is the setup process for new job or payrate?"/>
            <column name="DSCRM_TYP_CD" value="S"/>
            <column name="RULE_ID" value="KPME0024"/>
            <column name="VER_NBR" value="0"/>
        </insert>

        <insert tableName="KRMS_PROP_PARM_T">
            <column name="PROP_PARM_ID" value="KPME0019"/>
            <column name="PROP_ID" value="KPME0007"/>
            <column name="PARM_VAL" value="KPME0006"/>
            <column name="PARM_TYP_CD" value="T"/>
            <column name="SEQ_NO" value="0"/>
            <column name="VER_NBR" value="0"/>
        </insert>

        <insert tableName="KRMS_PROP_PARM_T">
            <column name="PROP_PARM_ID" value="KPME0020"/>
            <column name="PROP_ID" value="KPME0007"/>
            <column name="PARM_VAL" value="="/>
            <column name="PARM_TYP_CD" value="O"/>
            <column name="SEQ_NO" value="2"/>
            <column name="VER_NBR" value="0"/>
        </insert>

        <insert tableName="KRMS_PROP_PARM_T">
            <column name="PROP_PARM_ID" value="KPME0021"/>
            <column name="PROP_ID" value="KPME0007"/>
            <column name="PARM_VAL" value="New Job/Payrate"/>
            <column name="PARM_TYP_CD" value="C"/>
            <column name="SEQ_NO" value="1"/>
            <column name="VER_NBR" value="0"/>
        </insert>
        
        <insert tableName="KRMS_RULE_T">
            <column name="RULE_ID" value="KPME0024"/>
            <column name="NMSPC_CD" value="KPME-HR"/>
            <column name="NM" value="Routing for new job or pay rate"/>
            <column name="DESC_TXT" value="Process selected in employee setup doc was New Job/Payrate"/>
            <column name="PROP_ID" value="KPME0007"/>
            <column name="ACTV" value="Y"/>
            <column name="VER_NBR" value="0"/>
        </insert>        
    </changeSet>
    
    
    <changeSet id="6" author="neerajsk" context="kpme-server-bootstrap">
        <comment>Create an agenda for the employee setup, and its initial agenda item (pointing to the rule created above). </comment>
      
        <insert tableName="KRMS_AGENDA_T">
            <column name="AGENDA_ID" value="KPME0007" />
            <column name="NM" value="KPME Employee Setup Agenda" />
            <column name="CNTXT_ID" value="KPME-EMP-SETUP-CONTEXT" />
            <column name="INIT_AGENDA_ITM_ID" value="KPME0024"/>
            <column name="ACTV" value="Y" />
        </insert>
        
        <insert tableName="KRMS_AGENDA_ITM_T">
            <column name="AGENDA_ITM_ID" value="KPME0024"/>
            <column name="RULE_ID" value="KPME0024"/>
            <column name="AGENDA_ID" value="KPME0007"/>
            <column name="VER_NBR" value="1"/>
        </insert>
        
    </changeSet>
   
   
    <changeSet id="7" author="neerajsk" context="kpme-server-bootstrap">
        <comment>Create a proposition that checks if the value of the setup process is 'Change Job Dates', and use that proposition in a new rule. </comment>
        
        <insert tableName="KRMS_PROP_T">
            <column name="PROP_ID" value="KPME0008"/>
            <column name="DESC_TXT" value="Is the setup process for changing job dates?"/>
            <column name="DSCRM_TYP_CD" value="S"/>
            <column name="RULE_ID" value="KPME0025"/>
            <column name="VER_NBR" value="0"/>
        </insert>

        <insert tableName="KRMS_PROP_PARM_T">
            <column name="PROP_PARM_ID" value="KPME0022"/>
            <column name="PROP_ID" value="KPME0008"/>
            <column name="PARM_VAL" value="KPME0006"/>
            <column name="PARM_TYP_CD" value="T"/>
            <column name="SEQ_NO" value="0"/>
            <column name="VER_NBR" value="0"/>
        </insert>

        <insert tableName="KRMS_PROP_PARM_T">
            <column name="PROP_PARM_ID" value="KPME0023"/>
            <column name="PROP_ID" value="KPME0008"/>
            <column name="PARM_VAL" value="="/>
            <column name="PARM_TYP_CD" value="O"/>
            <column name="SEQ_NO" value="2"/>
            <column name="VER_NBR" value="0"/>
        </insert>

        <insert tableName="KRMS_PROP_PARM_T">
            <column name="PROP_PARM_ID" value="KPME0024"/>
            <column name="PROP_ID" value="KPME0008"/>
            <column name="PARM_VAL" value="Change Job Dates"/>
            <column name="PARM_TYP_CD" value="C"/>
            <column name="SEQ_NO" value="1"/>
            <column name="VER_NBR" value="0"/>
        </insert>
        
        <insert tableName="KRMS_RULE_T">
            <column name="RULE_ID" value="KPME0025"/>
            <column name="NMSPC_CD" value="KPME-HR"/>
            <column name="NM" value="Routing for changing job dates"/>
            <column name="DESC_TXT" value="Process selected in employee setup doc was Change Job Dates"/>
            <column name="PROP_ID" value="KPME0008"/>
            <column name="ACTV" value="Y"/>
            <column name="VER_NBR" value="0"/>
        </insert>        
    </changeSet>   
    
    <changeSet id="8" author="neerajsk" context="kpme-server-bootstrap">
        <comment>Create an agenda item that points to above rule and update the when-false branch of the previous agenda item to point to this item. </comment>
     
    	<insert tableName="KRMS_AGENDA_ITM_T">
            <column name="AGENDA_ITM_ID" value="KPME0025"/>
            <column name="RULE_ID" value="KPME0025"/>
            <column name="AGENDA_ID" value="KPME0007"/>
            <column name="VER_NBR" value="1"/>
        </insert>

        <update tableName="KRMS_AGENDA_ITM_T">
            <column name="WHEN_FALSE" value = "KPME0025"/>
            <where>AGENDA_ITM_ID = 'KPME0024'</where>
        </update>
    </changeSet>
    
    
    <changeSet id="9" author="neerajsk" context="kpme-server-bootstrap">
        <comment>Create a proposition that checks if the value of the setup process is a 'Update Job Details', and use that proposition in a new rule. </comment>
        
        <insert tableName="KRMS_PROP_T">
            <column name="PROP_ID" value="KPME0009"/>
            <column name="DESC_TXT" value="Is the setup process for updating job details?"/>
            <column name="DSCRM_TYP_CD" value="S"/>
            <column name="RULE_ID" value="KPME0026"/>
            <column name="VER_NBR" value="0"/>
        </insert>

        <insert tableName="KRMS_PROP_PARM_T">
            <column name="PROP_PARM_ID" value="KPME0025"/>
            <column name="PROP_ID" value="KPME0009"/>
            <column name="PARM_VAL" value="KPME0006"/>
            <column name="PARM_TYP_CD" value="T"/>
            <column name="SEQ_NO" value="0"/>
            <column name="VER_NBR" value="0"/>
        </insert>

        <insert tableName="KRMS_PROP_PARM_T">
            <column name="PROP_PARM_ID" value="KPME0026"/>
            <column name="PROP_ID" value="KPME0009"/>
            <column name="PARM_VAL" value="="/>
            <column name="PARM_TYP_CD" value="O"/>
            <column name="SEQ_NO" value="2"/>
            <column name="VER_NBR" value="0"/>
        </insert>

        <insert tableName="KRMS_PROP_PARM_T">
            <column name="PROP_PARM_ID" value="KPME0027"/>
            <column name="PROP_ID" value="KPME0009"/>
            <column name="PARM_VAL" value="Update Job Details"/>
            <column name="PARM_TYP_CD" value="C"/>
            <column name="SEQ_NO" value="1"/>
            <column name="VER_NBR" value="0"/>
        </insert>
        
        <insert tableName="KRMS_RULE_T">
            <column name="RULE_ID" value="KPME0026"/>
            <column name="NMSPC_CD" value="KPME-HR"/>
            <column name="NM" value="Routing for updating job details"/>
            <column name="DESC_TXT" value="Process selected in employee setup doc was Update Job Details"/>
            <column name="PROP_ID" value="KPME0009"/>
            <column name="ACTV" value="Y"/>
            <column name="VER_NBR" value="0"/>
        </insert>        
    </changeSet>   
    
    <changeSet id="10" author="neerajsk" context="kpme-server-bootstrap">
        <comment>Create an agenda item that points to above rule and update the when-false branch of the previous agenda item to point to this item. </comment>
     
    	<insert tableName="KRMS_AGENDA_ITM_T">
            <column name="AGENDA_ITM_ID" value="KPME0026"/>
            <column name="RULE_ID" value="KPME0026"/>
            <column name="AGENDA_ID" value="KPME0007"/>
            <column name="VER_NBR" value="1"/>
        </insert>

        <update tableName="KRMS_AGENDA_ITM_T">
            <column name="WHEN_FALSE" value = "KPME0026"/>
            <where>AGENDA_ITM_ID = 'KPME0025'</where>
        </update>
    </changeSet>
    
    
    <changeSet id="11" author="neerajsk" context="kpme-server-bootstrap">
        <comment>Create a proposition that checks if the value of the setup process is a 'End Job', and use that proposition in a new rule. </comment>
        
        <insert tableName="KRMS_PROP_T">
            <column name="PROP_ID" value="KPME0010"/>
            <column name="DESC_TXT" value="Is the setup process for ending job?"/>
            <column name="DSCRM_TYP_CD" value="S"/>
            <column name="RULE_ID" value="KPME0027"/>
            <column name="VER_NBR" value="0"/>
        </insert>

        <insert tableName="KRMS_PROP_PARM_T">
            <column name="PROP_PARM_ID" value="KPME0028"/>
            <column name="PROP_ID" value="KPME0010"/>
            <column name="PARM_VAL" value="KPME0006"/>
            <column name="PARM_TYP_CD" value="T"/>
            <column name="SEQ_NO" value="0"/>
            <column name="VER_NBR" value="0"/>
        </insert>

        <insert tableName="KRMS_PROP_PARM_T">
            <column name="PROP_PARM_ID" value="KPME0029"/>
            <column name="PROP_ID" value="KPME0010"/>
            <column name="PARM_VAL" value="="/>
            <column name="PARM_TYP_CD" value="O"/>
            <column name="SEQ_NO" value="2"/>
            <column name="VER_NBR" value="0"/>
        </insert>

        <insert tableName="KRMS_PROP_PARM_T">
            <column name="PROP_PARM_ID" value="KPME0030"/>
            <column name="PROP_ID" value="KPME0010"/>
            <column name="PARM_VAL" value="End Job"/>
            <column name="PARM_TYP_CD" value="C"/>
            <column name="SEQ_NO" value="1"/>
            <column name="VER_NBR" value="0"/>
        </insert>
        
        <insert tableName="KRMS_RULE_T">
            <column name="RULE_ID" value="KPME0027"/>
            <column name="NMSPC_CD" value="KPME-HR"/>
            <column name="NM" value="Routing for ending job"/>
            <column name="DESC_TXT" value="Process selected in employee setup doc was End Job"/>
            <column name="PROP_ID" value="KPME0010"/>
            <column name="ACTV" value="Y"/>
            <column name="VER_NBR" value="0"/>
        </insert>        
    </changeSet>   
    
    <changeSet id="12" author="neerajsk" context="kpme-server-bootstrap">
        <comment>Create an agenda item that points to above rule and update the when-false branch of the previous agenda item to point to this item. </comment>
     
    	<insert tableName="KRMS_AGENDA_ITM_T">
            <column name="AGENDA_ITM_ID" value="KPME0027"/>
            <column name="RULE_ID" value="KPME0027"/>
            <column name="AGENDA_ID" value="KPME0007"/>
            <column name="VER_NBR" value="1"/>
        </insert>

        <update tableName="KRMS_AGENDA_ITM_T">
            <column name="WHEN_FALSE" value = "KPME0027"/>
            <where>AGENDA_ITM_ID = 'KPME0026'</where>
        </update>
    </changeSet>
    
    
    <changeSet id="13" author="neerajsk" context="kpme-server-bootstrap">
    	<comment>Create a maintain KPME-HR agenda permission, and assign it to three sys-admin roles: position, leave and time. </comment>

        <insert tableName="KRIM_PERM_T">
            <column name="PERM_ID" value="KPME0191" />
            <column name="PERM_TMPL_ID" valueComputed="(SELECT PERM_TMPL_ID FROM KRIM_PERM_TMPL_T WHERE NMSPC_CD = 'KR-RULE' AND NM = 'KRMS Agenda Permission')" />
            <column name="NMSPC_CD" value="KPME-HR" />
            <column name="NM" value="Maintain KRMS Agenda" />
            <column name="DESC_TXT" value="Allows users to maintain any KPME-HR namespace agendas." />
            <column name="ACTV_IND" value="Y" />
            <column name="OBJ_ID" valueComputed="SYS_GUID()" />
            <column name="VER_NBR" value="1" />
        </insert>

        <insert tableName="KRIM_ROLE_PERM_T">
            <column name="ROLE_PERM_ID" value="KPME0949" />
            <column name="ROLE_ID" valueComputed="(SELECT ROLE_ID FROM KRIM_ROLE_T WHERE NMSPC_CD = 'KPME-PM' AND ROLE_NM = 'Position System Administrator')" />
            <column name="PERM_ID" valueComputed="(SELECT PERM_ID FROM KRIM_PERM_T WHERE NMSPC_CD = 'KPME-HR' AND NM = 'Maintain KRMS Agenda')" />
            <column name="ACTV_IND" value="Y" />
            <column name="OBJ_ID" valueComputed="SYS_GUID()" />
            <column name="VER_NBR" value="1" />
        </insert>
        
        <insert tableName="KRIM_ROLE_PERM_T">
            <column name="ROLE_PERM_ID" value="KPME0950" />
            <column name="ROLE_ID" valueComputed="(SELECT ROLE_ID FROM KRIM_ROLE_T WHERE NMSPC_CD = 'KPME-TK' AND ROLE_NM = 'Time System Administrator')" />
            <column name="PERM_ID" valueComputed="(SELECT PERM_ID FROM KRIM_PERM_T WHERE NMSPC_CD = 'KPME-HR' AND NM = 'Maintain KRMS Agenda')" />
            <column name="ACTV_IND" value="Y" />
            <column name="OBJ_ID" valueComputed="SYS_GUID()" />
            <column name="VER_NBR" value="1" />
        </insert>
        
        <insert tableName="KRIM_ROLE_PERM_T">
            <column name="ROLE_PERM_ID" value="KPME0951" />
            <column name="ROLE_ID" valueComputed="(SELECT ROLE_ID FROM KRIM_ROLE_T WHERE NMSPC_CD = 'KPME-LM' AND ROLE_NM = 'Leave System Administrator')" />
            <column name="PERM_ID" valueComputed="(SELECT PERM_ID FROM KRIM_PERM_T WHERE NMSPC_CD = 'KPME-HR' AND NM = 'Maintain KRMS Agenda')" />
            <column name="ACTV_IND" value="Y" />
            <column name="OBJ_ID" valueComputed="SYS_GUID()" />
            <column name="VER_NBR" value="1" />
        </insert>
        
        
        <modifySql dbms="mysql">
            <replace replace="SYS_GUID()" with="UUID()" />
        </modifySql>
    </changeSet>
    
    
</databaseChangeLog>